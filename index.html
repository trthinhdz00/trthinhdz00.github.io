<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Exercise 3 – 33 câu trắc nghiệm</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
:root{--accent:#6366f1}
body{background:linear-gradient(135deg,#f8fafc,#fff);font-family:Inter,system-ui,Segoe UI,-apple-system}
.card{background:#fff;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(15,23,42,.08)}
.tab{padding:8px 14px;border-radius:10px;cursor:pointer;user-select:none}
.tab-active{background:var(--accent);color:#fff}
.btn{padding:.6rem 1rem;border-radius:.75rem}
.btn-ghost{background:#f3f4f6}
.btn-primary{background:var(--accent);color:#fff}
.progress-wrap{height:8px;background:#eef2ff;border-radius:999px;overflow:hidden}
.progress{height:100%;background:var(--accent);width:0%}
.choice{transition:transform .12s,box-shadow .12s,background .12s,border-color .12s}
.choice:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(99,102,241,.14)}
.choice.selected{border-color:#6366f1;background:linear-gradient(180deg,#ffffff,#eef2ff)}
.choice.correct{border-color:#16a34a;background:#ecfdf5}
.choice.wrong{border-color:#dc2626;background:#fef2f2}
.choice:disabled{opacity:.7;cursor:not-allowed}
.reveal{margin-top:.5rem;font-size:.9rem}
.reveal .ok{color:#166534}
.reveal .bad{color:#991b1b}
.sticky-submit{position:sticky;bottom:-8px;background:linear-gradient(180deg,rgba(255,255,255,0),rgba(255,255,255,.95));padding-top:8px}
.section-title{font-weight:700;margin:12px 0 6px}
.fade{animation:fade .28s ease-out both}@keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.small-note{font-size:.75rem;color:#6b7280}
.badge{border-radius:.5rem;padding:.15rem .45rem;font-size:.75rem;font-weight:600}
.badge-ok{background:#dcfce7;color:#166534}
.badge-wrong{background:#fee2e2;color:#991b1b}
.badge-blank{background:#e5e7eb;color:#374151}
.row{display:grid;grid-template-columns:64px 1fr 90px 120px;gap:.5rem;align-items:center}
.row div{font-size:.9rem}
@media (max-width:640px){ .row{grid-template-columns:54px 1fr 70px 104px} }
</style>
</head>
<body class="min-h-screen flex items-start justify-center py-8">
<div class="w-full max-w-4xl px-4">
  <header class="mb-4 text-center">
    <h1 class="text-2xl font-extrabold">Exercise 3 – 33 câu trắc nghiệm</h1>
    <p class="text-sm text-gray-500">
      Bấm chọn đáp án: <b>hiện ngay đúng/sai + đáp án đúng của câu đó</b>. <b>Làm lại</b> sẽ xáo trộn câu & đáp án. F5 <b>không mất bài</b>.
    </p>
  </header>

  <div class="card space-y-4 fade">
    <div class="flex gap-2 items-center">
      <div id="tabQuiz" class="tab tab-active">Làm bài</div>
      <div id="tabResult" class="tab">Kết quả</div>

      <div class="ml-auto flex items-center gap-2">
        <div class="hidden sm:flex items-center gap-2 text-sm text-gray-600">
          <span>Thời gian:</span>
          <span id="clock" class="font-semibold text-gray-800">20:00</span>
        </div>
        <button id="btnResetAll" class="btn btn-ghost">Làm lại</button>
        <button id="btnSubmitTop" class="btn btn-primary">Nộp bài</button>
      </div>
    </div>

    <div class="progress-wrap"><div id="progress" class="progress"></div></div>

    <div id="quizArea" class="space-y-6"></div>

    <div class="sticky-submit">
      <button id="btnSubmitBottom" class="btn btn-primary w-full">Nộp bài</button>
      <div class="small-note mt-2">* Có thể xem bảng tổng kết trong tab “Kết quả”.</div>
    </div>

    <div id="resultArea" class="hidden">
      <div class="text-center py-6">
        <div id="scoreBig" class="text-4xl font-extrabold text-gray-800"></div>
        <div id="scoreSmall" class="text-sm text-gray-600 mt-2"></div>
        <div class="mt-4 grid grid-cols-3 gap-3 max-w-md mx-auto">
          <div class="p-3 bg-white rounded shadow text-center"><div class="text-sm text-gray-500">Đúng</div><div id="numCorrect" class="text-xl font-semibold text-green-600">0</div></div>
          <div class="p-3 bg-white rounded shadow text-center"><div class="text-sm text-gray-500">Sai</div><div id="numWrong" class="text-xl font-semibold text-rose-600">0</div></div>
          <div class="p-3 bg-white rounded shadow text-center"><div class="text-sm text-gray-500">Chưa chọn</div><div id="numBlank" class="text-xl font-semibold text-gray-600">0</div></div>
        </div>

        <div class="text-left mt-6">
          <button id="toggleDetail" class="btn btn-ghost w-full">Xem chi tiết từng câu</button>
          <div id="detailList" class="hidden mt-3 p-3 bg-white rounded-lg border space-y-2"></div>
        </div>
      </div>
    </div>

    <div class="text-right text-xs text-gray-400">© <span id="yy"></span> Trường Thịnh</div>
  </div>
</div>

<script>
document.getElementById('yy').textContent = new Date().getFullYear();

/* ===== CẤU HÌNH ===== */
const EXAM_MINUTES = 20;
const STORAGE_KEY   = "exercise3_33_reveal_per_question_v1";

/* ===== 33 câu ===== */
const QUESTIONS_SOURCE = [
  {id:"ex3-1", prompt:"Parents should share household ______ so that no one feels overloaded.", options:["jobs","work","chores","duties"], answer:2},
  {id:"ex3-2", prompt:"We should use public transport more often to help protect the ______.", options:["nature","air","planet","environment"], answer:3},
  {id:"ex3-3", prompt:"We should recycle plastic bottles instead of throwing them into the ______.", options:["bin","land","park","rubbish"], answer:0},
  {id:"ex3-4", prompt:"Families with strong ______ usually have better communication and understanding.", options:["rules","values","bonds","chores"], answer:2},
  {id:"ex3-5", prompt:"Teenagers should learn to be more ______ by doing simple household tasks.", options:["careful","hardworking","responsible","patient"], answer:2},
  {id:"ex3-6", prompt:"Turning off lights helps us save both energy and ______.", options:["electricity","environment","money","carbon"], answer:2},
  {id:"ex3-7", prompt:"Taylor Swift’s latest ______ has topped the music charts for weeks.", options:["song","playlist","album","rhythm"], answer:2},
  {id:"ex3-8", prompt:"The orchestra will ______ a concert at the city theatre next month.", options:["compose","perform","produce","direct"], answer:1},
  {id:"ex3-9", prompt:"My father often ______ the heavy lifting in our family.", options:["do","does","is doing","has done"], answer:1},
  {id:"ex3-10", prompt:"We usually ______ turns to cook dinner.", options:["take","taking","are taking","took"], answer:0},
  {id:"ex3-11", prompt:"He ______ the garbage every morning before going to work.", options:["takes out","is taking out","took out","has taken out"], answer:0},
  {id:"ex3-12", prompt:"Look! The children ______ the living room.", options:["clean","are cleaning","cleans","cleaned"], answer:1},
  {id:"ex3-13", prompt:"My mother ______ the laundry on Sundays.", options:["does","doing","did","has done"], answer:0},
  {id:"ex3-14", prompt:"Helping with household chores ______ children become more responsible.", options:["make","made","makes","is making"], answer:2},
  {id:"ex3-15", prompt:"Listen! The band ______ a new song on stage.", options:["play","plays","are playing","have played"], answer:2},
  {id:"ex3-16", prompt:"I think the new song ______ a big hit.", options:["will be","is being","is going to be","be"], answer:0},
  {id:"ex3-17", prompt:"People ______ use electric cars more in the future.", options:["are going to","will","uses","used"], answer:1},
  {id:"ex3-18", prompt:"They ______ a concert next weekend to raise money for charity.", options:["hold","will holding","are going to hold","holding"], answer:2},
  {id:"ex3-19", prompt:"New recycling machines ______ in the city next month.", options:["are installed","were installed","will install","will be installed"], answer:3},
  {id:"ex3-20", prompt:"Trees ______ every year to make the city greener.", options:["plant","are planted","were planted","will plant"], answer:1},
  {id:"ex3-21", prompt:"Plastic bottles ______ into new products in many factories.", options:["recycle","are recycled","were recycled","will recycle"], answer:1},
  {id:"ex3-22", prompt:"Solar energy ______ by many countries in the future.", options:["will use","will be used","is used","was used"], answer:1},
  {id:"ex3-23", prompt:"The singer is talented, ____ she needs more experience on stage.", options:["and","so","but","for"], answer:2},
  {id:"ex3-24", prompt:"She plays the guitar beautifully, ____ she can also compose songs.", options:["but","and","or","yet"], answer:1},
  {id:"ex3-25", prompt:"Tom practices the piano every day, ____ he still finds it hard to perform.", options:["so","for","yet","or"], answer:2},
  {id:"ex3-26", prompt:"The concert was canceled, ____ the fans were very disappointed.", options:["but","so","or","yet"], answer:1},
  {id:"ex3-27", prompt:"You can download the song for free ____ buy the full album online.", options:["and","but","or","yet"], answer:2},
  {id:"ex3-28", prompt:"She decided _______ a new piano for her music class.", options:["buy","buying","to buy","bought"], answer:2},
  {id:"ex3-29", prompt:"We heard the band _______ their new song at the concert.", options:["to perform","performing","perform","performed"], answer:2},
  {id:"ex3-30", prompt:"The music club plans _______ a charity concert next month.", options:["organizing","to organize","organize","to be organized"], answer:1},
  {id:"ex3-31", prompt:"The students were happy _______ the music competition.", options:["join","to join","joining","joined"], answer:1},
  {id:"ex3-32", prompt:"Let the choir _______ their song before we leave.", options:["to finish","finish","finished","finishing"], answer:1},
  {id:"ex3-33", prompt:"She promised _______ her voice for the school concert.", options:["using","use","to use","used"], answer:2}
];

/* ===== LOGIC ===== */
const tabQuiz = document.getElementById('tabQuiz');
const tabResult = document.getElementById('tabResult');
const quizArea = document.getElementById('quizArea');
const resultArea = document.getElementById('resultArea');
const btnSubmitTop = document.getElementById('btnSubmitTop');
const btnSubmitBottom = document.getElementById('btnSubmitBottom');
const btnResetAll = document.getElementById('btnResetAll');
const clockEl = document.getElementById('clock');
const progressEl = document.getElementById('progress');
const scoreBig = document.getElementById('scoreBig');
const scoreSmall = document.getElementById('scoreSmall');
const numCorrect = document.getElementById('numCorrect');
const numWrong = document.getElementById('numWrong');
const numBlank = document.getElementById('numBlank');
const detailList = document.getElementById('detailList');
const toggleDetail = document.getElementById('toggleDetail');

let state=null, timer=null;

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
function formatMMSS(s){ const m=String(Math.floor(s/60)).padStart(2,"0"); const sc=String(s%60).padStart(2,"0"); return `${m}:${sc}`; }
function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function restore(){ try{const s=localStorage.getItem(STORAGE_KEY); return s?JSON.parse(s):null;}catch{return null;} }
function letter(idx){ return idx>=0 ? String.fromCharCode(65+idx) : "-" }

function buildNewAttempt(){
  const working = QUESTIONS_SOURCE.map(q=>({...q,options:[...q.options]}));
  shuffle(working);
  working.forEach(q=>{
    const pairs=q.options.map((opt,idx)=>({opt,idx}));
    shuffle(pairs);
    q._order=pairs.map(p=>p.idx);   // idx hiển thị -> idx gốc
    q._opts =pairs.map(p=>p.opt);
  });
  return {working,answers:{},revealed:{},remainSec:EXAM_MINUTES*60,submitted:false};
}

function handleChoice(q, idx, grid, card){
  // đã trả lời rồi thì bỏ qua
  if (state.revealed[q.id]) return;
  state.answers[q.id]=idx;
  state.revealed[q.id]=true;

  // xác định đúng/sai
  const correctShownIdx = q._order.findIndex(i=>Number(i)===Number(q.answer));
  const isCorrect = (idx===correctShownIdx);

  // khoá các nút
  [...grid.children].forEach((btn,i)=>{
    btn.disabled = true;
    btn.classList.remove('selected');
    // tô màu: đáp án đúng -> xanh; bạn chọn sai -> đỏ
    if (i===correctShownIdx) btn.classList.add('correct','ring-1','ring-green-500');
    if (!isCorrect && i===idx) btn.classList.add('wrong','ring-1','ring-red-500');
  });

  // thêm khối Giải
  const rev = document.createElement('div');
  rev.className = 'reveal';
  rev.innerHTML = isCorrect
    ? `<span class="ok font-medium">✅ Chính xác!</span> Đáp án đúng: <b>${letter(correctShownIdx)}</b>.`
    : `<span class="bad font-medium">❌ Chưa đúng.</span> Đáp án đúng là <b>${letter(correctShownIdx)}</b>.`;
  card.appendChild(rev);

  persist();
}

function renderQuiz(){
  quizArea.innerHTML='';
  const title=document.createElement('div');
  title.className='section-title'; title.textContent='Exercise 3 – 33 câu';
  quizArea.appendChild(title);

  state.working.forEach((q,i)=>{
    const card=document.createElement('div'); card.className='p-3 bg-white rounded-lg border fade';
    const t=document.createElement('div'); t.className='font-medium mb-2'; t.textContent=`Câu ${i+1}. ${q.prompt}`; card.appendChild(t);

    const grid=document.createElement('div'); grid.className='grid sm:grid-cols-2 gap-2';
    q._opts.forEach((txt,idx)=>{
      const btn=document.createElement('button');
      btn.className='choice w-full text-left px-3 py-2 rounded border bg-gray-50';
      btn.innerHTML=`<b class="pr-2">${String.fromCharCode(65+idx)}.</b> ${txt}`;

      // Nếu đã trả lời trước đó (khôi phục từ localStorage), render lại trạng thái
      if (state.answers[q.id]===idx && state.revealed[q.id]) btn.classList.add('selected');
      btn.addEventListener('click',()=>handleChoice(q, idx, grid, card));

      grid.appendChild(btn);
    });
    card.appendChild(grid);

    // Nếu đã reveal trước (F5), phải tô màu + hiển thị giải
    if (state.revealed[q.id]) {
      const chosenIdx = state.answers[q.id];
      const correctShownIdx = q._order.findIndex(i=>Number(i)===Number(q.answer));
      [...grid.children].forEach((btn,i)=>{
        btn.disabled = true;
        if (i===correctShownIdx) btn.classList.add('correct','ring-1','ring-green-500');
        if (i===chosenIdx && i!==correctShownIdx) btn.classList.add('wrong','ring-1','ring-red-500');
      });
      const rev = document.createElement('div');
      rev.className = 'reveal';
      rev.innerHTML = (chosenIdx===correctShownIdx)
        ? `<span class="ok font-medium">✅ Chính xác!</span> Đáp án đúng: <b>${letter(correctShownIdx)}</b>.`
        : `<span class="bad font-medium">❌ Chưa đúng.</span> Đáp án đúng là <b>${letter(correctShownIdx)}</b>.`;
      card.appendChild(rev);
    }

    quizArea.appendChild(card);
  });
}

function grade(){
  let total=state.working.length, correct=0, blank=0;
  state.working.forEach(q=>{
    const chosen=state.answers[q.id];
    if(typeof chosen!=='number'){ blank++; return; }
    const correctShownIdx = q._order.findIndex(i=>Number(i)===Number(q.answer));
    if(chosen===correctShownIdx) correct++;
  });
  const wrong = total - correct - blank;
  const percent = total? Math.round(100*correct/total):0;
  return {total,correct,wrong,blank,percent};
}

function buildReviewHTML(){
  const rows = state.working.map((q,idx)=>{
    const chosenIdx = state.answers[q.id];
    const correctShownIdx = q._order.findIndex(i=>Number(i)===Number(q.answer));
    let badgeClass='badge-blank', badgeText='Chưa chọn';
    if(typeof chosenIdx==='number'){
      if(chosenIdx===correctShownIdx){ badgeClass='badge-ok'; badgeText='Đúng'; }
      else { badgeClass='badge-wrong'; badgeText='Sai'; }
    }
    const you = typeof chosenIdx==='number' ? letter(chosenIdx) : '-';
    const corr= letter(correctShownIdx);
    return `
      <div class="row">
        <div class="text-gray-500">Câu ${idx+1}</div>
        <div class="text-gray-800 truncate">${q.prompt}</div>
        <div><span class="badge ${badgeClass}">${badgeText}</span></div>
        <div class="text-right sm:text-left"><span class="text-gray-500 mr-1">Bạn:</span><b>${you}</b> · <span class="text-gray-500 mr-1">Đúng:</span><b>${corr}</b></div>
      </div>
    `;
  }).join('');
  return `<div class="text-sm text-gray-600 mb-2">Chi tiết:</div><div class="space-y-2">${rows}</div>`;
}

function showResult(){
  const r=grade();
  scoreBig.textContent=`${r.percent}%`;
  scoreSmall.textContent=`${r.correct}/${r.total} câu đúng`;
  numCorrect.textContent=r.correct; numWrong.textContent=r.wrong; numBlank.textContent=r.blank;
  if(detailList){ detailList.innerHTML = buildReviewHTML(); }
  resultArea.classList.remove('hidden'); showTab('result');
}

/* ===== TIMER ===== */
function startTimer(){
  stopTimer();
  timer=setInterval(()=>{
    state.remainSec--; updateClock();
    if(state.remainSec<=0){ stopTimer(); if(!state.submitted){ state.submitted=true; persist(); showResult(); } }
    else persist();
  },1000);
}
function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }
function updateClock(){
  const left=Math.max(0,state.remainSec);
  clockEl.textContent=formatMMSS(left);
  const used=(EXAM_MINUTES*60-left);
  progressEl.style.width=(Math.max(0,Math.min(1,used/(EXAM_MINUTES*60)))*100).toFixed(1)+'%';
}

/* ===== TAB & EVENTS ===== */
function showTab(t){
  const q=document.getElementById('tabQuiz'), r=document.getElementById('tabResult');
  if(t==='quiz'){ q.classList.add('tab-active'); r.classList.remove('tab-active'); quizArea.classList.remove('hidden'); resultArea.classList.add('hidden'); }
  else{ r.classList.add('tab-active'); q.classList.remove('tab-active'); quizArea.classList.add('hidden'); resultArea.classList.remove('hidden'); }
}
document.getElementById('tabQuiz').addEventListener('click',()=>showTab('quiz'));
document.getElementById('tabResult').addEventListener('click',()=>showTab('result'));

function handleSubmit(){ if(state.submitted) return showResult(); state.submitted=true; persist(); stopTimer(); showResult(); }
document.getElementById('btnSubmitTop').addEventListener('click',handleSubmit);
document.getElementById('btnSubmitBottom').addEventListener('click',handleSubmit);

document.getElementById('btnResetAll').addEventListener('click',()=>{
  if(!confirm('Làm lại bài? Thứ tự câu hỏi & đáp án sẽ được xáo trộn.')) return;
  state=buildNewAttempt(); persist(); renderQuiz(); updateClock(); startTimer(); showTab('quiz');
});

if (toggleDetail){
  toggleDetail.addEventListener('click', ()=>{
    const hidden = detailList.classList.contains('hidden');
    detailList.classList.toggle('hidden', !hidden);
    toggleDetail.textContent = hidden ? 'Ẩn chi tiết từng câu' : 'Xem chi tiết từng câu';
  });
}

window.addEventListener('beforeunload',(e)=>{ if(!state.submitted){ e.preventDefault(); e.returnValue=''; } });

/* ===== INIT ===== */
(function init(){
  const restored=restore();
  if(restored && restored.working && restored.answers && restored.revealed){
    state=restored;
  }else{
    state=buildNewAttempt();
  }
  renderQuiz(); updateClock(); if(!state.submitted) startTimer();
})();
</script>
</body>
</html>
