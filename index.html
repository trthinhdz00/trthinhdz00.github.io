<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Thi/Luyện tập – Trường Thịnh</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<style>
:root{ --accent:#6366f1 }
body{ background:linear-gradient(135deg,#f8fafc,#ffffff); font-family:Inter,system-ui,Segoe UI,-apple-system }
.card{ background:rgba(255,255,255,.85); backdrop-filter:blur(8px); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(15,23,42,.08) }
.tab{ padding:8px 14px; border-radius:10px; cursor:pointer; user-select:none }
.tab-active{ background:var(--accent); color:#fff }
.btn{ padding:.6rem 1rem; border-radius:.75rem }
.btn-ghost{ background:#f3f4f6 }
.btn-primary{ background:var(--accent); color:#fff }
.progress-wrap{ height:8px; background:#eef2ff; border-radius:999px; overflow:hidden }
.progress{ height:100%; background:var(--accent); width:0% }
.choice{ transition:transform .12s, box-shadow .12s, background .12s, border-color .12s }
.choice:hover{ transform:translateY(-2px); box-shadow:0 8px 24px rgba(99,102,241,.14) }
.choice.selected{ border-color:#6366f1; background:linear-gradient(180deg,#ffffff,#eef2ff) }
.sticky-submit{ position:sticky; bottom:-8px; background:linear-gradient(180deg,rgba(255,255,255,0),rgba(255,255,255,.95)); padding-top:8px }
.section-title{ font-weight:700; margin:12px 0 6px }
.fade{ animation:fade .28s ease-out both } @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.ta{ width:100%; min-height:90px; border:1px solid #e5e7eb; padding:.75rem; border-radius:.75rem; background:#f9fafb }
.ta:focus{ outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.15) }
.stat{ padding:.75rem 1rem; background:#fff; border-radius:.75rem; box-shadow:0 4px 14px rgba(15,23,42,.06); text-align:center }
.small-note{font-size:.75rem;color:#6b7280}
</style>
</head>
<body class="min-h-screen flex items-start justify-center py-8">
<div class="w-full max-w-4xl px-4">
  <header class="mb-4 text-center">
    <h1 class="text-2xl font-extrabold">Bài kiểm tra tổng hợp</h1>
    <p class="text-sm text-gray-500">
      Làm xong bấm <b>Nộp bài</b> để xem điểm. <b>Làm lại</b> sẽ xáo trộn thứ tự câu hỏi & đáp án.
      Refresh trang <b>không mất bài</b> (giữ trạng thái).
    </p>
  </header>

  <div class="card space-y-4 fade">
    <!-- Tabs + controls -->
    <div class="flex gap-2 items-center">
      <div id="tabQuiz" class="tab tab-active">Làm bài</div>
      <div id="tabResult" class="tab">Kết quả</div>

      <div class="ml-auto flex items-center gap-2">
        <div class="hidden sm:flex items-center gap-2 text-sm text-gray-600">
          <span>Thời gian:</span>
          <span id="clock" class="font-semibold text-gray-800">20:00</span>
        </div>
        <button id="btnResetAll" class="btn btn-ghost">Làm lại</button>
        <button id="btnSubmitTop" class="btn btn-primary">Nộp bài</button>
      </div>
    </div>

    <!-- Timer bar -->
    <div class="progress-wrap">
      <div id="progress" class="progress"></div>
    </div>

    <!-- QUIZ AREA -->
    <div id="quizArea" class="space-y-6"></div>

    <!-- Bottom submit -->
    <div class="sticky-submit">
      <button id="btnSubmitBottom" class="btn btn-primary w-full">Nộp bài</button>
      <div class="small-note mt-2">
        * Không lộ đáp án theo từng câu. Gợi ý Passive chỉ xem được sau khi nộp.
      </div>
    </div>

    <!-- RESULT AREA -->
    <div id="resultArea" class="hidden">
      <div class="text-center py-6">
        <div id="scoreBig" class="text-4xl font-extrabold text-gray-800"></div>
        <div id="scoreSmall" class="text-sm text-gray-600 mt-2"></div>
        <div class="mt-4 grid grid-cols-3 gap-3 max-w-md mx-auto">
          <div class="stat"><div class="text-sm text-gray-500">Đúng</div><div id="numCorrect" class="text-xl font-semibold text-green-600">0</div></div>
          <div class="stat"><div class="text-sm text-gray-500">Sai</div><div id="numWrong" class="text-xl font-semibold text-rose-600">0</div></div>
          <div class="stat"><div class="text-sm text-gray-500">Chưa chọn</div><div id="numBlank" class="text-xl font-semibold text-gray-600">0</div></div>
        </div>

        <!-- Passive hints -->
        <div class="mt-6 max-w-2xl mx-auto">
          <button id="btnShowPassiveHints" class="btn btn-ghost w-full">Xem gợi ý mẫu – Passive Voice</button>
          <div id="passiveHints" class="hidden mt-3 p-3 bg-white rounded-lg border text-sm leading-relaxed"></div>
        </div>

        <p class="text-xs text-gray-500 mt-4">
          Chỉ hiển thị tổng điểm sau khi nộp. Gợi ý Passive để tự đối chiếu, không chấm tự động.
        </p>
      </div>
    </div>

    <div class="text-right text-xs text-gray-400">© <span id="yy"></span> Trường Thịnh</div>
  </div>
</div>

<script>
document.getElementById('yy').textContent = new Date().getFullYear();

/* ====== CẤU HÌNH ====== */
const EXAM_MINUTES = 20;
const STORAGE_KEY   = "thinh_exam_with_passive_v4";

/* ====== MCQ (lấy từ đề bạn gửi) ====== */
const QUESTIONS_SOURCE = [
  {id:"q1", prompt:"Parents should share household ______ so that no one feels overloaded.", options:["jobs","work","chores","duties"], answer:2},
  {id:"q2", prompt:"We should use public transport more often to help protect the ______.", options:["nature","air","planet","environment"], answer:3},
  {id:"q3", prompt:"Recycle plastic bottles instead of throwing them into the ______.", options:["bin","land","park","rubbish"], answer:0},
  {id:"q4", prompt:"Families with strong ______ usually have better communication.", options:["rules","values","bonds","chores"], answer:2},
  {id:"q5", prompt:"Teenagers should learn to be more ______ by doing simple household tasks.", options:["careful","hardworking","responsible","patient"], answer:2},
  {id:"q6", prompt:"Turning off lights helps us save both energy and ______.", options:["electricity","environment","money","carbon"], answer:2},
  {id:"q7", prompt:"Taylor Swift’s latest ______ has topped the music charts for weeks.", options:["song","playlist","album","rhythm"], answer:2},
  {id:"q8", prompt:"The orchestra will ______ a concert next month.", options:["compose","perform","produce","direct"], answer:1},
  {id:"q9", prompt:"My father often ______ the heavy lifting in our family.", options:["do","does","is doing","has done"], answer:1},
  {id:"q10", prompt:"We usually ______ turns to cook dinner.", options:["take","taking","are taking","took"], answer:0},
  {id:"q11", prompt:"He ______ the garbage every morning before work.", options:["takes out","is taking out","took out","has taken out"], answer:0},
  {id:"q12", prompt:"Look! The children ______ the living room.", options:["clean","are cleaning","cleans","cleaned"], answer:1},
  {id:"q13", prompt:"My mother ______ the laundry on Sundays.", options:["does","doing","did","has done"], answer:0},
  {id:"q14", prompt:"Helping with household chores ______ children become more responsible.", options:["make","made","makes","is making"], answer:2},
  {id:"q15", prompt:"Listen! The band ______ a new song on stage.", options:["play","plays","are playing","have played"], answer:2},
  {id:"q16", prompt:"I think the new song ______ a big hit.", options:["will be","is being","is going to be","be"], answer:0},
  {id:"q17", prompt:"People ______ use electric cars more in the future.", options:["are going to","will","uses","used"], answer:1},
  {id:"q18", prompt:"They ______ a concert next weekend to raise money for charity.", options:["hold","will holding","are going to hold","holding"], answer:2},
  {id:"q19", prompt:"New recycling machines ______ in the city next month.", options:["are installed","were installed","will install","will be installed"], answer:3},
  {id:"q20", prompt:"Trees ______ every year to make the city greener.", options:["plant","are planted","were planted","will plant"], answer:1},
  {id:"q21", prompt:"Plastic bottles ______ into new products in many factories.", options:["recycle","are recycled","were recycled","will recycle"], answer:1},
  {id:"q22", prompt:"Solar energy ______ by many countries in the future.", options:["will use","will be used","is used","was used"], answer:1},
  {id:"q23", prompt:"The singer is talented, ____ she needs more experience on stage.", options:["and","so","but","for"], answer:2},
  {id:"q24", prompt:"She plays the guitar beautifully, ____ she can also compose songs.", options:["but","and","or","yet"], answer:1},
  {id:"q25", prompt:"Tom practices the piano every day, ____ he still finds it hard to perform.", options:["so","for","yet","or"], answer:2},
  {id:"q26", prompt:"The concert was canceled, ____ the fans were very disappointed.", options:["but","so","or","yet"], answer:1},
  {id:"q27", prompt:"You can download the song for free ____ buy the full album online.", options:["and","but","or","yet"], answer:2},
  {id:"q28", prompt:"She decided _______ a new piano for her music class.", options:["buy","buying","to buy","bought"], answer:2},
  {id:"q29", prompt:"We heard the band _______ their new song at the concert.", options:["to perform","performing","perform","performed"], answer:2},
  {id:"q30", prompt:"The music club plans _______ a charity concert next month.", options:["organizing","to organize","organize","to be organized"], answer:1},
];

/* ====== PASSIVE VOICE (10 câu – tự luận có gợi ý mẫu sau khi nộp) ====== */
const PASSIVE_SOURCE = [
  {id:"pv1",  prompt:"Pollution affects the environment in many ways. → (Passive)",                    solution:"The environment is affected in many ways (by pollution)."},
  {id:"pv2",  prompt:"Americans use around 100 billion plastic bags each year. → (Passive)",           solution:"Around 100 billion plastic bags are used each year (by Americans)."},
  {id:"pv3",  prompt:"People will build this building next year. → (Passive)",                         solution:"This building will be built next year."},
  {id:"pv4",  prompt:"The club’s activities will raise people’s awareness of environmental issues. →",  solution:"People’s awareness of environmental issues will be raised by the club’s activities."},
  {id:"pv5",  prompt:"My mother is going to sell this house. → (Passive)",                             solution:"This house is going to be sold (by my mother)."},
  {id:"pv6",  prompt:"The students are going to plant trees here. → (Passive)",                        solution:"Trees are going to be planted here (by the students)."},
  {id:"pv7",  prompt:"They are building a new music school in the city. → (Passive)",                  solution:"A new music school is being built in the city."},
  {id:"pv8",  prompt:"The students are cleaning the school playground this morning. → (Passive)",      solution:"The school playground is being cleaned this morning (by the students)."},
  {id:"pv9",  prompt:"People will build this building next year. (repeat) → (Passive)",                solution:"This building will be built next year."},
  {id:"pv10", prompt:"Americans use around 100 billion plastic bags each year. (repeat) → (Passive)",  solution:"Around 100 billion plastic bags are used each year (by Americans)."}
];

/* ====== BIẾN / TIỆN ÍCH ====== */
const tabQuiz = document.getElementById('tabQuiz');
const tabResult = document.getElementById('tabResult');
const quizArea = document.getElementById('quizArea');
const resultArea = document.getElementById('resultArea');
const btnSubmitTop = document.getElementById('btnSubmitTop');
const btnSubmitBottom = document.getElementById('btnSubmitBottom');
const btnResetAll = document.getElementById('btnResetAll');
const clockEl = document.getElementById('clock');
const progressEl = document.getElementById('progress');
const scoreBig = document.getElementById('scoreBig');
const scoreSmall = document.getElementById('scoreSmall');
const numCorrect = document.getElementById('numCorrect');
const numWrong = document.getElementById('numWrong');
const numBlank = document.getElementById('numBlank');
const btnShowPassiveHints = document.getElementById('btnShowPassiveHints');
const passiveHints = document.getElementById('passiveHints');

let state = null; // { working:[], answers:{}, essaysPassive:{}, remainSec, submitted }
let timer = null;

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
function formatMMSS(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const sc=(s%60).toString().padStart(2,'0'); return `${m}:${sc}`; }
function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function restore(){ try{ const s=localStorage.getItem(STORAGE_KEY); return s? JSON.parse(s): null }catch{return null} }

function buildNewAttempt(){
  const working = QUESTIONS_SOURCE.map(q => ({...q, options:[...q.options]}));
  shuffle(working); // xáo trộn thứ tự câu hỏi
  working.forEach(q=>{
    const pairs=q.options.map((opt,idx)=>({opt,idx}));
    shuffle(pairs);
    q._order=pairs.map(p=>p.idx);   // index hiển thị -> index gốc
    q._opts =pairs.map(p=>p.opt);   // danh sách phương án sau khi xáo
  });
  return {
    working,
    answers:{},
    essaysPassive:{},       // lưu bài làm phần Passive
    remainSec: EXAM_MINUTES*60,
    submitted:false
  };
}

/* ====== RENDER ====== */
function renderMCQ(){
  const wrap=document.createElement('div');
  wrap.className='space-y-3';
  const title=document.createElement('div');
  title.className='section-title';
  title.textContent='I. Trắc nghiệm (MCQ)';
  wrap.appendChild(title);

  state.working.forEach((q,i)=>{
    const card=document.createElement('div');
    card.className='p-3 bg-white rounded-lg border fade';
    const t=document.createElement('div');
    t.className='font-medium mb-2';
    t.textContent=`Câu ${i+1}. ${q.prompt}`;
    card.appendChild(t);

    const grid=document.createElement('div');
    grid.className='grid sm:grid-cols-2 gap-2';

    q._opts.forEach((txt,idx)=>{
      const btn=document.createElement('button');
      btn.className='choice w-full text-left px-3 py-2 rounded border bg-gray-50';
      btn.innerHTML=`<b class="pr-2">${String.fromCharCode(65+idx)}.</b> ${txt}`;
      if(state.answers[q.id]===idx) btn.classList.add('selected','ring-1','ring-indigo-500');
      btn.addEventListener('click',()=>{
        state.answers[q.id]=idx;
        [...grid.children].forEach(c=>c.classList.remove('selected','ring-1','ring-indigo-500'));
        btn.classList.add('selected','ring-1','ring-indigo-500');
        persist();
      });
      grid.appendChild(btn);
    });

    card.appendChild(grid);
    wrap.appendChild(card);
  });

  return wrap;
}

function renderPassive(){
  const wrap=document.createElement('div');
  wrap.className='space-y-3';
  const title=document.createElement('div');
  title.className='section-title';
  title.textContent='II. Tự luận – Passive Voice';
  wrap.appendChild(title);

  PASSIVE_SOURCE.forEach((e,idx)=>{
    const card=document.createElement('div');
    card.className='p-3 bg-white rounded-lg border fade';
    const label=document.createElement('div');
    label.className='font-medium mb-2';
    label.textContent=`Câu PV ${idx+1}. ${e.prompt}`;
    card.appendChild(label);

    const ta=document.createElement('textarea');
    ta.className='ta';
    ta.placeholder='Viết lại câu ở đây (bị động)...';
    ta.value=(state.essaysPassive && state.essaysPassive[e.id]) || '';
    ta.addEventListener('input',()=>{
      state.essaysPassive[e.id]=ta.value;
      persist();
    });
    card.appendChild(ta);

    wrap.appendChild(card);
  });

  return wrap;
}

function renderQuiz(){
  quizArea.innerHTML='';
  quizArea.appendChild(renderMCQ());
  quizArea.appendChild(renderPassive());
}

/* ====== CHẤM MCQ & KẾT QUẢ ====== */
function grade(){
  let total=state.working.length, correct=0, blank=0;
  state.working.forEach(q=>{
    const chosen=state.answers[q.id];
    if(typeof chosen!=='number'){ blank++; return; }
    const originalIndex=q._order[chosen];
    if(Number(originalIndex)===Number(q.answer)) correct++;
  });
  const wrong = total - correct - blank;
  const percent = total? Math.round(100*correct/total):0;
  return {total,correct,wrong,blank,percent};
}

function showResult(){
  const r=grade();
  scoreBig.textContent = `${r.percent}%`;
  scoreSmall.textContent = `${r.correct}/${r.total} câu đúng (MCQ)`;
  numCorrect.textContent = r.correct;
  numWrong.textContent  = r.wrong;
  numBlank.textContent  = r.blank;

  // Dựng gợi ý Passive (ẩn mặc định, chỉ xem sau khi nộp)
  if (passiveHints){
    const html = PASSIVE_SOURCE.map((e,i)=>(
      `<div class="mb-2"><b>PV ${i+1}.</b> ${e.solution}</div>`
    )).join('');
    passiveHints.innerHTML = html;
  }

  resultArea.classList.remove('hidden');
  showTab('result');
}

/* ====== TIMER ====== */
function startTimer(){
  stopTimer();
  timer=setInterval(()=>{
    state.remainSec--;
    updateClock();
    if(state.remainSec<=0){
      stopTimer();
      if(!state.submitted){ state.submitted=true; persist(); showResult(); }
    }else{
      persist();
    }
  },1000);
}
function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }
function updateClock(){
  const left=Math.max(0,state.remainSec);
  clockEl.textContent=formatMMSS(left);
  const used=(EXAM_MINUTES*60-left);
  const ratio=Math.max(0,Math.min(1,used/(EXAM_MINUTES*60)));
  progressEl.style.width=(ratio*100).toFixed(1)+'%';
}

/* ====== TAB & EVENTS ====== */
function showTab(t){
  if(t==='quiz'){
    tabQuiz.classList.add('tab-active'); tabResult.classList.remove('tab-active');
    quizArea.classList.remove('hidden');  resultArea.classList.add('hidden');
  }else{
    tabResult.classList.add('tab-active'); tabQuiz.classList.remove('tab-active');
    quizArea.classList.add('hidden');     resultArea.classList.remove('hidden');
  }
}
tabQuiz.addEventListener('click',()=>showTab('quiz'));
tabResult.addEventListener('click',()=>showTab('result'));

function handleSubmit(){
  if(state.submitted) return showResult();
  state.submitted=true; persist(); stopTimer(); showResult();
}
btnSubmitTop.addEventListener('click',handleSubmit);
btnSubmitBottom.addEventListener('click',handleSubmit);

btnResetAll.addEventListener('click',()=>{
  if(!confirm('Làm lại bài? Thứ tự câu hỏi & đáp án sẽ được xáo trộn.')) return;
  const keepPassive = state.essaysPassive; // nếu muốn reset cả phần Passive, xoá 2 dòng giữ này
  state=buildNewAttempt();
  state.essaysPassive = keepPassive;      // giữ phần tự luận Passive khi làm lại (để không mất công đã gõ)
  persist(); renderQuiz(); updateClock(); startTimer(); showTab('quiz');
});

if (btnShowPassiveHints){
  btnShowPassiveHints.addEventListener('click',()=>{
    const hidden=passiveHints.classList.contains('hidden');
    passiveHints.classList.toggle('hidden', !hidden);
    btnShowPassiveHints.textContent = hidden ? 'Ẩn gợi ý mẫu – Passive Voice' : 'Xem gợi ý mẫu – Passive Voice';
  });
}

window.addEventListener('beforeunload',(e)=>{ if(!state.submitted){ e.preventDefault(); e.returnValue=''; } });

/* ====== INIT ====== */
(function init(){
  const restored=restore();
  if(restored && restored.working && restored.answers!=null){
    state=restored;
    if(!state.essaysPassive) state.essaysPassive={}; // nâng cấp dữ liệu cũ
  }else{
    state=buildNewAttempt();
  }
  renderQuiz(); updateClock(); if(!state.submitted) startTimer();
})();
</script>
</body>
</html>
